<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estúdio Mabe ERP</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-white text-gray-900 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto space-y-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900">Estúdio Mabe</h1>
            <h2 class="text-xl mt-2 font-semibold">Sistema de Gestão ERP</h2>
        </header>

        <!-- User ID and Status Section -->
        <div class="bg-gray-100 p-4 rounded-xl shadow-md">
            <p class="text-sm font-medium">Status de Autenticação:</p>
            <p id="auth-status" class="text-sm font-light text-green-700">Autenticando...</p>
            <p id="user-id-display" class="text-xs mt-2 break-all text-gray-600"></p>
        </div>

        <!-- Main Content Area -->
        <div id="main-content-container">
            <!-- Login View -->
            <section id="login-view" class="bg-gray-50 p-6 rounded-xl shadow-lg space-y-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Acesso do Funcionário</h3>
                <p class="text-sm text-gray-600">
                    Insira seu nome de usuário e senha para registrar seu ponto.
                </p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username-input" class="block text-sm font-medium">Nome de Usuário</label>
                        <input type="text" id="username-input" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                    </div>
                    <div>
                        <label for="password-input" class="block text-sm font-medium">Senha</label>
                        <input type="password" id="password-input" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                    </div>
                    <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Entrar</button>
                    <p id="login-error-message" class="text-red-700 text-sm text-center"></p>
                </form>
                <div class="border-t border-gray-300 pt-4 mt-4 text-center">
                    <button id="switch-to-admin-btn" class="text-sm text-gray-600 hover:underline">Painel do Administrador</button>
                </div>
            </section>
            
            <!-- Admin Login View -->
            <section id="admin-login-view" class="hidden bg-gray-50 p-6 rounded-xl shadow-lg space-y-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Acesso do Administrador</h3>
                <p class="text-sm text-gray-600">
                    Por favor, insira a senha de administrador para continuar.
                </p>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-password-input" class="block text-sm font-medium">Senha de Administrador</label>
                        <input type="password" id="admin-password-input" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                    </div>
                    <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Entrar</button>
                    <p id="admin-login-error-message" class="text-red-700 text-sm text-center"></p>
                </form>
                <div class="border-t border-gray-300 pt-4 mt-4 text-center">
                    <button id="switch-to-login-from-admin-btn" class="text-sm text-gray-600 hover:underline">Trocar para o Painel do Funcionário</button>
                </div>
            </section>

            <!-- Dashboard View -->
            <section id="dashboard-view" class="hidden bg-gray-50 p-6 rounded-xl shadow-lg space-y-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">Dashboard do Administrador</h3>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="dashboard-employee-btn" class="w-full sm:w-1/2 bg-gray-900 hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300">Gerenciar Funcionários</button>
                    <button id="dashboard-projects-btn" class="w-full sm:w-1/2 bg-gray-900 hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300">Gerenciar Projetos</button>
                </div>
                <div class="border-t border-gray-300 pt-4 mt-4 text-center">
                    <button id="switch-to-employee-btn" class="text-sm text-gray-600 hover:underline">Trocar para o Painel do Funcionário</button>
                </div>
            </section>

            <!-- Admin View (Employee Management) -->
            <section id="admin-view" class="hidden space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <button id="switch-to-dashboard-from-admin-btn" class="text-sm text-gray-600 hover:underline">Voltar para o Dashboard</button>
                    <button id="switch-to-employee-from-admin-btn" class="text-sm text-gray-600 hover:underline">Trocar para o Painel do Funcionário</button>
                </div>
                <!-- Employee Registration Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Cadastro de Funcionários</h3>
                    <form id="employee-form" class="space-y-4">
                        <div>
                            <label for="employee-name" class="block text-sm font-medium">Nome do Funcionário</label>
                            <input type="text" id="employee-name" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <div>
                            <label for="employee-role" class="block text-sm font-medium">Função</label>
                            <input type="text" id="employee-role" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <div>
                            <label for="employee-cpf" class="block text-sm font-medium">CPF</label>
                            <input type="text" id="employee-cpf" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700" pattern="\d{3}\.?\d{3}\.?\d{3}-?\d{2}" title="Formato de CPF: 000.000.000-00">
                        </div>
                        <div>
                            <label for="employee-phone" class="block text-sm font-medium">Telefone</label>
                            <input type="text" id="employee-phone" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <p id="phone-error-message" class="text-red-700 text-sm mt-2 hidden">Telefone inválido. Por favor, inclua o DDD e o formato correto (ex: 11987654321).</p>
                        <div>
                            <label for="employee-cep" class="block text-sm font-medium">CEP</label>
                            <input type="text" id="employee-cep" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700" pattern="\d{5}-?\d{3}" title="Formato de CEP: 00000-000">
                        </div>
                        <div>
                            <label for="employee-address" class="block text-sm font-medium">Endereço</label>
                            <input type="text" id="employee-address" required readonly class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 text-gray-900 shadow-sm p-2">
                        </div>
                        <div>
                            <label for="employee-city" class="block text-sm font-medium">Cidade</label>
                            <input type="text" id="employee-city" required readonly class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 text-gray-900 shadow-sm p-2">
                        </div>
                        <div>
                            <label for="employee-number" class="block text-sm font-medium">Número</label>
                            <input type="text" id="employee-number" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <div>
                            <label for="employee-complement" class="block text-sm font-medium">Complemento (Opcional)</label>
                            <input type="text" id="employee-complement" class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Adicionar Funcionário</button>
                    </form>
                    <p id="cpf-error-message" class="text-red-700 text-sm mt-2 hidden">CPF inválido. Por favor, verifique o número.</p>
                    <div id="new-employee-info" class="mt-4 p-4 rounded-md bg-gray-100 hidden">
                        <p class="font-semibold text-sm">Novo funcionário adicionado:</p>
                        <p id="new-employee-username" class="text-sm"></p>
                        <p id="new-employee-password" class="text-sm"></p>
                    </div>
                </div>

                <!-- Employee List and Time Clock Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Controle de Ponto (Admin)</h3>
                    <div class="flex items-center space-x-2 mb-4">
                        <label for="month-year-input" class="text-sm font-medium">Analisar mês:</label>
                        <input type="month" id="month-year-input" class="flex-1 rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        <button id="filter-btn" class="bg-gray-900 hover:bg-gray-800 text-white font-bold py-1 px-4 rounded-lg shadow-md transition duration-300">Filtrar</button>
                    </div>
                    <div id="employee-list" class="space-y-4">
                        <!-- Employee cards will be dynamically inserted here -->
                        <p id="loading-employees" class="text-center text-sm text-gray-500">Carregando funcionários...</p>
                    </div>
                </div>

                <!-- Time Records Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Registros de Ponto (Admin)</h3>
                    <div id="time-records" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Time records will be dynamically inserted here -->
                        <p id="loading-records" class="text-center text-sm text-gray-500">Carregando registros...</p>
                    </div>
                </div>
            </section>
            
            <!-- Project Admin View -->
            <section id="project-admin-view" class="hidden space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <button id="switch-to-dashboard-from-projects-btn" class="text-sm text-gray-600 hover:underline">Voltar para o Dashboard</button>
                </div>
                <!-- Project Registration Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Cadastro de Projetos</h3>
                    <form id="project-form" class="space-y-4">
                        <div>
                            <label for="project-name" class="block text-sm font-medium">Nome do Projeto</label>
                            <input type="text" id="project-name" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <div>
                            <label for="client-name" class="block text-sm font-medium">Nome do Cliente</label>
                            <input type="text" id="client-name" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                        </div>
                        <div>
                            <label for="project-description" class="block text-sm font-medium">Descrição do Projeto</label>
                            <textarea id="project-description" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Adicionar Projeto</button>
                    </form>
                </div>
                <!-- Project List Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Projetos em Andamento</h3>
                    <div id="project-list" class="space-y-4">
                        <!-- Project cards will be dynamically inserted here -->
                        <p id="loading-projects" class="text-center text-sm text-gray-500">Carregando projetos...</p>
                    </div>
                </div>
            </section>

            <!-- Employee View -->
            <section id="employee-view" class="hidden bg-gray-50 p-6 rounded-xl shadow-lg space-y-8 text-center">
                <h3 class="text-2xl font-bold text-gray-800">Painel do Funcionário</h3>
                <p id="employee-welcome" class="text-lg font-medium text-gray-700">Bem-vindo, <span id="logged-in-name"></span>!</p>
                
                <div id="employee-stats" class="text-left bg-gray-100 p-4 rounded-lg">
                    <p class="font-bold text-lg mb-2">Banco de Horas:</p>
                    <p id="employee-total-hours" class="text-2xl font-semibold text-gray-800">0.00 horas</p>
                </div>

                <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="employee-entrada-btn" class="w-full sm:w-auto bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">Entrada</button>
                    <button id="employee-saida-btn" class="w-full sm:w-auto bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">Saída</button>
                </div>
                
                <h4 class="text-xl font-bold text-gray-800">Meus Registros de Ponto</h4>
                <div id="my-time-records" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2">
                    <p class="text-center text-sm text-gray-500">Carregando seus registros...</p>
                </div>
                <button id="logout-btn" class="mt-4 text-sm text-gray-600 hover:underline">Sair</button>
            </section>

            <!-- Password Change View -->
            <section id="change-password-view" class="hidden bg-gray-50 p-6 rounded-xl shadow-lg space-y-4">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Crie sua nova senha</h3>
                <p class="text-sm text-gray-600">
                    Sua senha atual é temporária. Por favor, crie uma nova senha para sua conta.
                </p>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="new-password-input" class="block text-sm font-medium">Nova Senha</label>
                        <input type="password" id="new-password-input" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                    </div>
                    <div>
                        <label for="confirm-password-input" class="block text-sm font-medium">Confirme a Nova Senha</label>
                        <input type="password" id="confirm-password-input" required class="mt-1 block w-full rounded-md border-gray-300 bg-white text-gray-900 shadow-sm p-2 focus:ring-gray-700 focus:border-gray-700">
                    </div>
                    <button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Salvar Nova Senha</button>
                    <p id="password-change-error" class="text-red-700 text-sm text-center"></p>
                </form>
            </section>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // As seguintes variáveis são fornecidas automaticamente pelo ambiente.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'local-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId;
        let loggedInEmployee = null;
        let currentView = 'login'; // 'login', 'admin_login', 'dashboard', 'admin', 'employee', 'change_password', 'project_admin'
        
        const authStatusEl = document.getElementById('auth-status');
        const userIdDisplayEl = document.getElementById('user-id-display');

        // --- UI Element References ---
        const loginView = document.getElementById('login-view');
        const adminLoginView = document.getElementById('admin-login-view');
        const adminView = document.getElementById('admin-view');
        const projectAdminView = document.getElementById('project-admin-view');
        const employeeView = document.getElementById('employee-view');
        const dashboardView = document.getElementById('dashboard-view');
        const changePasswordView = document.getElementById('change-password-view');
        const employeeNameInput = document.getElementById('employee-name');
        const employeeRoleInput = document.getElementById('employee-role');
        const newEmployeeInfoEl = document.getElementById('new-employee-info');
        const newEmployeeUsernameEl = document.getElementById('new-employee-username');
        const newEmployeePasswordEl = document.getElementById('new-employee-password');
        const employeeListEl = document.getElementById('employee-list');
        const timeRecordsEl = document.getElementById('time-records');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loggedInNameEl = document.getElementById('logged-in-name');
        const myTimeRecordsEl = document.getElementById('my-time-records');
        const loginErrorMessageEl = document.getElementById('login-error-message');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginErrorMessageEl = document.getElementById('admin-login-error-message');
        const employeeEntradaBtn = document.getElementById('employee-entrada-btn');
        const employeeSaidaBtn = document.getElementById('employee-saida-btn');
        const newPasswordInput = document.getElementById('new-password-input');
        const confirmPasswordInput = document.getElementById('confirm-password-input');
        const passwordChangeError = document.getElementById('password-change-error');
        const employeeTotalHoursEl = document.getElementById('employee-total-hours');
        
        const projectNameInput = document.getElementById('project-name');
        const clientNameInput = document.getElementById('client-name');
        const projectDescriptionInput = document.getElementById('project-description');
        const projectListEl = document.getElementById('project-list');
        
        const employeeCpfInput = document.getElementById('employee-cpf');
        const cpfErrorMessageEl = document.getElementById('cpf-error-message');
        const employeePhoneInput = document.getElementById('employee-phone');
        const phoneErrorMessageEl = document.getElementById('phone-error-message');
        const employeeCepInput = document.getElementById('employee-cep');
        const employeeAddressInput = document.getElementById('employee-address');
        const employeeCityInput = document.getElementById('employee-city');
        const employeeNumberInput = document.getElementById('employee-number');
        const employeeComplementInput = document.getElementById('employee-complement');

        const filterBtn = document.getElementById('filter-btn');
        const monthYearInput = document.getElementById('month-year-input');
        
        const TEMPORARY_PASSWORD_PREFIX = 'temp_';
        const ADMIN_PASSWORD = '1233211234';
        
        let selectedDate = new Date();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authStatusEl.textContent = 'Autenticado com sucesso!';
                authStatusEl.classList.remove('text-red-700');
                authStatusEl.classList.add('text-green-700');
                userIdDisplayEl.textContent = `ID do Usuário: ${userId}`;
                updateView();
            } else {
                authStatusEl.textContent = 'Não autenticado. Tentando autenticar...';
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Falha na autenticação:", error);
                    authStatusEl.textContent = 'Falha na autenticação. Por favor, recarregue a página.';
                    authStatusEl.classList.remove('text-green-700');
                    authStatusEl.classList.add('text-red-700');
                }
            }
        });

        // --- Firestore Collections Pathing ---
        const getEmployeesCollectionRef = () => collection(db, `artifacts/${appId}/users/${userId}/employees`);
        const getTimeRecordsCollectionRef = () => collection(db, `artifacts/${appId}/users/${userId}/time_records`);
        const getProjectsCollectionRef = () => collection(db, `artifacts/${appId}/users/${userId}/projects`);

        // --- Helper Functions ---
        const toUsername = (name) => {
            return name.toLowerCase().replace(/\s/g, '.');
        };

        const generatePassword = () => {
            // Add a prefix to mark it as a temporary password
            return TEMPORARY_PASSWORD_PREFIX + Math.random().toString(36).substring(2, 10);
        };
        
        function validateCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum = 0;
            let rest;
            for (let i = 1; i <= 9; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (11 - i);
            rest = (sum * 10) % 11;
            if ((rest === 10) || (rest === 11)) rest = 0;
            if (rest !== parseInt(cpf.substring(9, 10))) return false;
            sum = 0;
            for (let i = 1; i <= 10; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (12 - i);
            rest = (sum * 10) % 11;
            if ((rest === 10) || (rest === 11)) rest = 0;
            if (rest !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        function validatePhone(phone) {
            const cleanedPhone = phone.replace(/\D/g, '');
            // Check for valid phone numbers with 10 or 11 digits (with DDD)
            return cleanedPhone.length === 10 || cleanedPhone.length === 11;
        }

        async function fetchAddressFromCEP(cep) {
            cep = cep.replace(/\D/g, '');
            if (cep.length !== 8) return;

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    employeeAddressInput.value = data.logradouro;
                    employeeCityInput.value = data.localidade;
                } else {
                    displayMessage('CEP não encontrado.', true);
                    employeeAddressInput.value = '';
                    employeeCityInput.value = '';
                }
            } catch (e) {
                displayMessage('Erro ao buscar CEP. Tente novamente.', true);
                employeeAddressInput.value = '';
                employeeCityInput.value = '';
            }
        }


        const displayMessage = (message, isError = false) => {
            const el = document.getElementById('message-box') || document.createElement('div');
            el.id = 'message-box';
            el.className = `fixed bottom-4 right-4 p-4 rounded-md shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        };

        // --- Data Management Functions ---
        async function addEmployee(name, role, cpf, phone, cep, address, city, number, complement) {
            try {
                const username = toUsername(name);
                const password = generatePassword();
                
                // Store employee data, including username, password, and time bank
                const docRef = await addDoc(getEmployeesCollectionRef(), {
                    name: name,
                    role: role,
                    username: username,
                    password: password,
                    cpf: cpf,
                    phone: phone,
                    cep: cep,
                    address: address,
                    city: city,
                    number: number,
                    complement: complement,
                    timeBankHours: 0,
                    createdAt: serverTimestamp()
                });

                // Display username and password to the admin
                newEmployeeUsernameEl.textContent = `Usuário: ${username}`;
                newEmployeePasswordEl.textContent = `Senha temporária: ${password}`;
                newEmployeeInfoEl.classList.remove('hidden');

                displayMessage('Funcionário adicionado com sucesso!');

            } catch (e) {
                console.error("Erro ao adicionar funcionário: ", e);
                displayMessage(`Erro ao adicionar funcionário: ${e.message}`, true);
            }
        }

        async function recordTime(employeeId, employeeName, type) {
            console.log('Tentando registrar ponto. ID do Funcionário:', employeeId, 'Tipo:', type);
            try {
                await addDoc(getTimeRecordsCollectionRef(), {
                    employeeId,
                    employeeName,
                    type, // 'entrada' or 'saida'
                    timestamp: serverTimestamp()
                });
                console.log('Registro de ponto enviado com sucesso.');
                displayMessage(`Registro de ${type} para ${employeeName} adicionado.`);
            } catch (e) {
                console.error("Erro ao registrar ponto: ", e);
                displayMessage(`Erro ao registrar ponto: ${e.message}`, true);
            }
        }
        
        async function updateEmployeePassword(employeeId, newPassword) {
            try {
                const employeeDocRef = doc(db, `artifacts/${appId}/users/${userId}/employees`, employeeId);
                await updateDoc(employeeDocRef, {
                    password: newPassword
                });
                console.log('Senha do funcionário atualizada com sucesso.');
                displayMessage('Senha atualizada com sucesso!');
                loggedInEmployee.password = newPassword;
            } catch (e) {
                console.error("Erro ao atualizar senha: ", e);
                displayMessage(`Erro ao atualizar senha: ${e.message}`, true);
            }
        }
        
        function calculateTimeBankForPeriod(records) {
            let totalMilliseconds = 0;
            let lastEntry = null;
            
            // Sort records by timestamp
            records.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());

            for (const record of records) {
                if (record.type === 'entrada') {
                    lastEntry = record.timestamp.toMillis();
                } else if (record.type === 'saida' && lastEntry !== null) {
                    const duration = record.timestamp.toMillis() - lastEntry;
                    totalMilliseconds += duration;
                    lastEntry = null; // Reset for the next pair
                }
            }

            const totalHours = totalMilliseconds / (1000 * 60 * 60);
            return totalHours.toFixed(2);
        }

        async function addProject(projectName, clientName, description) {
            try {
                await addDoc(getProjectsCollectionRef(), {
                    projectName,
                    clientName,
                    description,
                    status: 'Em Andamento',
                    createdAt: serverTimestamp()
                });
                displayMessage('Projeto adicionado com sucesso!');
            } catch (e) {
                console.error("Erro ao adicionar projeto: ", e);
                displayMessage(`Erro ao adicionar projeto: ${e.message}`, true);
            }
        }

        async function updateProjectStatus(projectId, newStatus) {
            try {
                const projectDocRef = doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId);
                await updateDoc(projectDocRef, {
                    status: newStatus
                });
                displayMessage('Status do projeto atualizado!');
            } catch (e) {
                console.error("Erro ao atualizar status do projeto: ", e);
                displayMessage(`Erro ao atualizar status do projeto: ${e.message}`, true);
            }
        }

        // --- View and Data Logic ---
        function updateView() {
            loginView.classList.add('hidden');
            adminView.classList.add('hidden');
            employeeView.classList.add('hidden');
            changePasswordView.classList.add('hidden');
            projectAdminView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            adminLoginView.classList.add('hidden');

            if (currentView === 'login') {
                loginView.classList.remove('hidden');
                usernameInput.value = '';
                passwordInput.value = '';
                loginErrorMessageEl.textContent = '';
                loggedInEmployee = null;
            } else if (currentView === 'admin_login') {
                adminLoginView.classList.remove('hidden');
            } else if (currentView === 'admin') {
                adminView.classList.remove('hidden');
                setupAdminListeners();
            } else if (currentView === 'employee') {
                employeeView.classList.remove('hidden');
                setupEmployeeListeners();
            } else if (currentView === 'change_password') {
                changePasswordView.classList.remove('hidden');
            } else if (currentView === 'project_admin') {
                projectAdminView.classList.remove('hidden');
                setupProjectAdminListeners();
            } else if (currentView === 'dashboard') {
                dashboardView.classList.remove('hidden');
            }
        }
        
        const getTimestampForMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const startOfMonth = new Date(year, month, 1);
            const endOfMonth = new Date(year, month + 1, 0);
            endOfMonth.setHours(23, 59, 59, 999);
            return {
                start: startOfMonth.getTime(),
                end: endOfMonth.getTime()
            };
        };

        function setupAdminListeners() {
            // Set initial month/year input value to current month
            const today = new Date();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            monthYearInput.value = `${year}-${month}`;

            // Listen for changes in the employees collection
            const employeeQuery = query(getEmployeesCollectionRef(), orderBy('name'));
            onSnapshot(employeeQuery, (employeeSnapshot) => {
                const employees = employeeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Listen for changes in all time records
                const recordsQuery = query(getTimeRecordsCollectionRef(), orderBy('timestamp', 'desc'));
                onSnapshot(recordsQuery, async (recordsSnapshot) => {
                    const allTimeRecords = recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const updateUIWithFilteredData = (filteredRecords) => {
                        // Update employee list with calculated hours for the filtered period
                        employeeListEl.innerHTML = '';
                        if (employees.length === 0) {
                            employeeListEl.innerHTML = '<p class="text-center text-sm text-gray-500">Nenhum funcionário cadastrado.</p>';
                        } else {
                            employees.forEach((employee) => {
                                const employeeTimeRecords = filteredRecords.filter(record => record.employeeId === employee.id);
                                const totalHours = calculateTimeBankForPeriod(employeeTimeRecords);
                                
                                const card = document.createElement('div');
                                card.className = 'bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between';
                                const displayPassword = employee.password.startsWith(TEMPORARY_PASSWORD_PREFIX) ? employee.password + ' (Temporária)' : '••••••••';
                                card.innerHTML = `
                                    <div>
                                        <h4 class="font-bold text-lg">${employee.name}</h4>
                                        <p class="text-sm text-gray-600">${employee.role}</p>
                                        <p class="text-sm text-gray-700 mt-1">Horas Acumuladas: <span class="font-bold text-gray-900">${totalHours}</span>h</p>
                                        <p class="text-sm text-gray-700">CPF: <span class="font-semibold">${employee.cpf}</span></p>
                                        <p class="text-sm text-gray-700">Telefone: <span class="font-semibold">${employee.phone}</span></p>
                                        <p class="text-sm text-gray-700">Endereço: <span class="font-semibold">${employee.address}, ${employee.number} - ${employee.city} ${employee.complement ? `(${employee.complement})` : ''}</span></p>
                                    </div>
                                    <div class="mt-4 sm:mt-0 space-y-1 text-left sm:text-right">
                                        <p class="text-sm text-gray-700">Usuário: <span class="font-semibold">${employee.username}</span></p>
                                        <p class="text-sm text-gray-700">Senha: <span class="font-semibold">${displayPassword}</span></p>
                                    </div>
                                `;
                                employeeListEl.appendChild(card);
                            });
                        }

                        // Update time records list (Admin view)
                        timeRecordsEl.innerHTML = '';
                        if (filteredRecords.length === 0) {
                            timeRecordsEl.innerHTML = '<p class="text-center text-sm text-gray-500">Nenhum registro de ponto encontrado para este período.</p>';
                        } else {
                            filteredRecords.forEach((record) => {
                                const time = record.timestamp ? new Date(record.timestamp.toMillis()).toLocaleString() : 'Carregando...';
                                const recordEl = document.createElement('p');
                                recordEl.className = `text-sm ${record.type === 'entrada' ? 'text-green-700' : 'text-red-700'}`;
                                recordEl.innerHTML = `<strong>${record.employeeName}</strong>: ${record.type.toUpperCase()} em ${time}`;
                                timeRecordsEl.appendChild(recordEl);
                            });
                        }
                    };
                    
                    const filterAndRender = () => {
                        const dateValue = monthYearInput.value;
                        if (dateValue) {
                            const [year, month] = dateValue.split('-').map(Number);
                            const start = new Date(year, month - 1, 1).getTime();
                            const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();

                            const filteredRecords = allTimeRecords.filter(record => {
                                const recordTime = record.timestamp.toMillis();
                                return recordTime >= start && recordTime <= end;
                            });
                            updateUIWithFilteredData(filteredRecords);
                        } else {
                            // If no date is selected, show all records
                            updateUIWithFilteredData(allTimeRecords);
                        }
                    };
                    
                    filterBtn.onclick = filterAndRender;
                    monthYearInput.onchange = filterAndRender;
                    
                    filterAndRender(); // Initial render
                });
            });
        }
        
        function setupProjectAdminListeners() {
            const projectsQuery = query(getProjectsCollectionRef(), orderBy('createdAt', 'desc'));
            onSnapshot(projectsQuery, (snapshot) => {
                console.log('Snapshot recebido para a lista de projetos. Documentos:', snapshot.docs.length);
                projectListEl.innerHTML = '';
                if (snapshot.empty) {
                    projectListEl.innerHTML = '<p class="text-center text-sm text-gray-500">Nenhum projeto cadastrado.</p>';
                } else {
                    const statuses = ['Em Andamento', 'Concluído', 'Pendente', 'Cancelado'];
                    snapshot.forEach(doc => {
                        const project = doc.data();
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow-sm space-y-2';
                        
                        let statusOptions = '';
                        statuses.forEach(status => {
                            const selected = project.status === status ? 'selected' : '';
                            statusOptions += `<option value="${status}" ${selected}>${status}</option>`;
                        });

                        card.innerHTML = `
                            <h4 class="font-bold text-lg">${project.projectName}</h4>
                            <p class="text-sm text-gray-600">Cliente: ${project.clientName}</p>
                            <p class="text-sm text-gray-600">
                                Status: 
                                <select class="bg-gray-100 rounded-md p-1 text-sm cursor-pointer" onchange="updateProjectStatus('${doc.id}', this.value)">
                                    ${statusOptions}
                                </select>
                            </p>
                            <p class="text-xs text-gray-500 mt-2">${project.description}</p>
                        `;
                        projectListEl.appendChild(card);
                    });
                }
            });
        }

        function setupEmployeeListeners() {
            // Display employee's name
            loggedInNameEl.textContent = loggedInEmployee.name;
            
            // Listen for the employee's time records only
            const myRecordsQuery = query(getTimeRecordsCollectionRef(), where('employeeId', '==', loggedInEmployee.id));
            onSnapshot(myRecordsQuery, async (snapshot) => {
                console.log('Snapshot recebido para registros do funcionário. Documentos:', snapshot.docs.length);
                
                // Calculate and display total hours
                const totalHours = calculateTimeBankForPeriod(snapshot.docs.map(doc => doc.data()));
                employeeTotalHoursEl.textContent = `${totalHours} horas`;

                myTimeRecordsEl.innerHTML = '';
                if (snapshot.empty) {
                    myTimeRecordsEl.innerHTML = '<p class="text-center text-sm text-gray-500">Você ainda não tem registros de ponto.</p>';
                } else {
                    // Sort records by timestamp client-side to avoid index requirement
                    const sortedRecords = snapshot.docs.map(doc => doc.data()).sort((a, b) => {
                        const timeA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
                        return timeB - timeA;
                    });
                    
                    sortedRecords.forEach((record) => {
                        const time = record.timestamp ? new Date(record.timestamp.toMillis()).toLocaleString() : 'Carregando...';
                        const recordEl = document.createElement('p');
                        recordEl.className = `text-sm ${record.type === 'entrada' ? 'text-green-700' : 'text-red-700'}`;
                        recordEl.innerHTML = `${record.type.toUpperCase()} em ${time}`;
                        myTimeRecordsEl.appendChild(recordEl);
                    });
                }
            }, (error) => {
                console.error("Erro no onSnapshot do funcionário:", error);
            });
        }

        // --- Event Listeners ---
        document.getElementById('switch-to-admin-btn').addEventListener('click', () => {
            currentView = 'admin_login';
            updateView();
        });

        document.getElementById('switch-to-employee-btn').addEventListener('click', () => {
            loggedInEmployee = null;
            currentView = 'login';
            updateView();
        });

        document.getElementById('switch-to-login-from-admin-btn').addEventListener('click', () => {
            currentView = 'login';
            updateView();
        });

        document.getElementById('dashboard-employee-btn').addEventListener('click', () => {
            currentView = 'admin';
            updateView();
        });

        document.getElementById('dashboard-projects-btn').addEventListener('click', () => {
            currentView = 'project_admin';
            updateView();
        });

        document.getElementById('switch-to-dashboard-from-admin-btn').addEventListener('click', () => {
            currentView = 'dashboard';
            updateView();
        });

        document.getElementById('switch-to-dashboard-from-projects-btn').addEventListener('click', () => {
            currentView = 'dashboard';
            updateView();
        });


        document.getElementById('logout-btn').addEventListener('click', async () => {
            loggedInEmployee = null;
            currentView = 'login';
            updateView();
            usernameInput.value = '';
            passwordInput.value = '';
        });

        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                currentView = 'dashboard';
                updateView();
                adminPasswordInput.value = '';
                adminLoginErrorMessageEl.textContent = '';
            } else {
                adminLoginErrorMessageEl.textContent = 'Senha incorreta.';
            }
        });

        document.getElementById('employee-form').addEventListener('submit', (e) => {
            e.preventDefault();
            newEmployeeInfoEl.classList.add('hidden');
            cpfErrorMessageEl.classList.add('hidden');
            phoneErrorMessageEl.classList.add('hidden');
            const name = employeeNameInput.value.trim();
            const role = employeeRoleInput.value.trim();
            const cpf = employeeCpfInput.value.trim();
            const phone = employeePhoneInput.value.trim();
            const cep = employeeCepInput.value.trim();
            const address = employeeAddressInput.value.trim();
            const city = employeeCityInput.value.trim();
            const number = employeeNumberInput.value.trim();
            const complement = employeeComplementInput.value.trim();
            
            if (!validateCPF(cpf)) {
                cpfErrorMessageEl.classList.remove('hidden');
                return;
            }

            if (!validatePhone(phone)) {
                phoneErrorMessageEl.classList.remove('hidden');
                return;
            }

            if (name && role && cpf && phone && address && city && number) {
                addEmployee(name, role, cpf, phone, cep, address, city, number, complement);
                employeeNameInput.value = '';
                employeeRoleInput.value = '';
                employeeCpfInput.value = '';
                employeePhoneInput.value = '';
                employeeCepInput.value = '';
                employeeAddressInput.value = '';
                employeeCityInput.value = '';
                employeeNumberInput.value = '';
                employeeComplementInput.value = '';
            }
        });
        
        // Novo listener para o botão na página de gerenciamento de funcionários
        document.getElementById('switch-to-employee-from-admin-btn').addEventListener('click', () => {
            loggedInEmployee = null;
            currentView = 'login';
            updateView();
        });

        document.getElementById('project-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const projectName = projectNameInput.value.trim();
            const clientName = clientNameInput.value.trim();
            const description = projectDescriptionInput.value.trim();
            if (projectName && clientName && description) {
                addProject(projectName, clientName, description);
                projectNameInput.value = '';
                clientNameInput.value = '';
                projectDescriptionInput.value = '';
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loginErrorMessageEl.textContent = '';
            const enteredUsername = usernameInput.value.trim();
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredUsername && enteredPassword) {
                const employeesRef = getEmployeesCollectionRef();
                const q = query(employeesRef, where('username', '==', enteredUsername));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const employeeDoc = querySnapshot.docs[0];
                    const employeeData = employeeDoc.data();
                    
                    if (employeeData.password === enteredPassword) {
                        loggedInEmployee = { id: employeeDoc.id, ...employeeData };
                        
                        // Check if it's a temporary password
                        if (employeeData.password.startsWith(TEMPORARY_PASSWORD_PREFIX)) {
                            currentView = 'change_password';
                        } else {
                            currentView = 'employee';
                        }
                        updateView();
                        console.log('Login de funcionário bem-sucedido. ID:', loggedInEmployee.id, 'Nome:', loggedInEmployee.name);
                    } else {
                        loginErrorMessageEl.textContent = 'Senha incorreta.';
                    }
                } else {
                    loginErrorMessageEl.textContent = 'Nome de usuário não encontrado.';
                }
            } else {
                loginErrorMessageEl.textContent = 'Por favor, insira o nome de usuário e a senha.';
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            passwordChangeError.textContent = '';
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                passwordChangeError.textContent = 'As senhas não coincidem.';
                return;
            }

            if (newPassword.length < 6) {
                passwordChangeError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                return;
            }

            await updateEmployeePassword(loggedInEmployee.id, newPassword);
            currentView = 'employee';
            updateView();
        });

        employeeEntradaBtn.addEventListener('click', () => {
            if (loggedInEmployee) {
                recordTime(loggedInEmployee.id, loggedInEmployee.name, 'entrada');
            } else {
                console.error('loggedInEmployee não definido. Não é possível registrar o ponto.');
            }
        });

        employeeSaidaBtn.addEventListener('click', () => {
            if (loggedInEmployee) {
                recordTime(loggedInEmployee.id, loggedInEmployee.name, 'saida');
            } else {
                console.error('loggedInEmployee não definido. Não é possível registrar o ponto.');
            }
        });
        
        employeeCepInput.addEventListener('blur', () => {
            fetchAddressFromCEP(employeeCepInput.value);
        });

        // Initial view setup
        window.onload = updateView;

    </script>
</body>
</html>
